name: Auto-define PR base branch

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  set-pr-base:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write  # Necesario para poder comentar en el PR
    steps:
      - name: Determine expected base
        id: determine
        run: |
          head=${{ github.event.pull_request.head.ref }}
          if [[ "$head" == feature/* ]]; then
            echo "base=dev" >> $GITHUB_OUTPUT
          elif [[ "$head" == dev ]]; then
            echo "base=main" >> $GITHUB_OUTPUT
          else
            echo "base=" >> $GITHUB_OUTPUT
          fi

      - name: Update PR base if needed
        id: update
        uses: actions/github-script@v6
        if: steps.determine.outputs.base && steps.determine.outputs.base != github.event.pull_request.base.ref
        with:
          script: |
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              base: '${{ steps.determine.outputs.base }}',
            });
            return 'updated';

      - name: Comment on PR about base change
        if: steps.update.outputs.result == 'updated'
        uses: actions/github-script@v6
        with:
          script: |
            const oldBase = '${{ github.event.pull_request.base.ref }}';
            const newBase = '${{ steps.determine.outputs.base }}';
            const headRef = '${{ github.event.pull_request.head.ref }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `🔄 **Auto-corrected PR base branch**  
                    
This PR was automatically updated to target \`${newBase}\` (was: \`${oldBase}\`) based on your branch name:
\`${headRef}\`

> ℹ️ _This ensures we follow our branching flow: \`feature/* → dev → main\`._`
            });
